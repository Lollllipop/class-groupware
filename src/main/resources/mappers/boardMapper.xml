<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ja.classgroupware.base.persistence.BoardDAO">
	<!-- pure -->
	<insert id="insert">
		insert into board(bo_idx, class_idx, user_idx, bo_title, bo_content, bo_writedate, bo_isnotice, bo_role, bo_views, bo_comments)
		values(board_seq.nextval, #{class_idx}, #{user_idx}, #{bo_title}, #{bo_content}, SYSDATE, #{bo_isnotice}, #{bo_role}, 0, 0)
	</insert>

	<select id="selectByIdx" resultType="com.ja.classgroupware.base.vo.BoardVO">
		select *
		from board
		where bo_idx = #{bo_idx}
	</select>

	<select id="selectAll" resultType="com.ja.classgroupware.base.vo.BoardVO">
		<![CDATA[
			select bo_idx, class_idx, user_idx, bo_title, bo_content, bo_writedate, bo_isnotice, bo_role 
			from board
			where bo_idx > 0 
			order by bo_idx desc
		]]>
	</select>

	<update id="update">
		update board 
		set bo_title = #{bo_title},
			bo_content = #{bo_content},
			bo_isnotice = #{bo_isnotice}, 
			bo_writedate = SYSDATE
		where bo_idx = #{bo_idx}
	</update>

	<delete id="delete">
		delete 
		from board 
		where bo_idx = #{bo_idx}
	</delete>


	<!-- mixed -->
	<select id="selectAllList" resultType="com.ja.classgroupware.board.domain.BoardDTO">
		select bo_idx, s.user_idx, bo_title, bo_writedate, bo_isnotice, bo_role, bo_views, user_name, bo_comments
		from board b, users s
		where b.user_idx = s.user_idx
	    and class_idx = #{class_idx}
	    and bo_role = #{bo_role} 
	</select>
	
	<select id="selectDetailByIdx" resultType="com.ja.classgroupware.board.domain.PostMainDTO">
		select bo_idx, s.user_idx, user_name, bo_title, bo_content, bo_writedate, bo_updatedate, bo_isnotice, bo_role, bo_views, bo_comments
		from board b, users s
		where b.user_idx = s.user_idx
		and bo_idx = #{bo_idx}
	</select>
	
	<!-- etc -->
	<select id="selectTotalCount" resultType="_int">
		select count(*)
		from board
	</select>
	
	<update id="updateViewsWithPlusOne">
		update board 
		set bo_views = bo_views + 1
		where bo_idx = #{bo_idx}
	</update>
	
	<select id="selectPage" resultType="com.ja.classgroupware.board.domain.BoardDTO">
		<![CDATA[
			SELECT *
			FROM (
			        SELECT a.*, ROWNUM AS rnum
			        FROM (
			                SELECT bo_idx, s.user_idx, bo_title, bo_writedate, bo_isnotice, bo_role, bo_views, user_name, bo_comments
			                FROM board b, users s
			                WHERE b.user_idx = s.user_idx
			                AND class_idx = #{class_idx}
			                AND bo_role = #{bo_role} 
			                ORDER BY bo_isnotice desc, ${pageInfo.sort} ${pageInfo.order}, bo_idx desc
			             ) a
			        WHERE ROWNUM <= #{pageInfo.max}
			    )
			WHERE rnum > #{pageInfo.offset}
		]]>
	</select>
</mapper>
